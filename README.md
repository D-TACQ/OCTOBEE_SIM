# Introduction
This is a magnetic simulation that simulates a linear scan in 3 dimensions of 3D Hall Effect sensors through a magnetic field.

The various files generate the scan path, do a simulation to get B-field reading of all points on that path.
This uses a configurable sample rate and time per axis of scan, with the default configuration 10kSPS.
A full path scan with one sensor and default time per axis generates ~80M points to be solved by the simulation.
The default number of sensors simulated is 8, each offset by 5mm from the adjacent sensor along a single axis.

# Setup
To install the dependencies a `requirements.txt` file has been provided.
This is easiest install and run from a virtual environment.
Create a virtual environment and install the requirements with pip:

```
python -m venv env_octo-bee
source env_octo-bee/bin/activate
pip install -r requirements.txt
```

To exit the virtual environment simpy type `deactivate` in the shell prompt.

# Run full simulation
The definition of all simulation parameters is done inside `config.yml`.
An example has been provided to get started.
You can copy this `config.yml` to create your own simulations.
After copying you must edit `config.py` to point to your edited version.

To run a full simulation, from definition of simulation to output to disk of muxed data, run these files in order:

`python path_scan_bfield_computation.py`  
After this first run with a single sensor you can plot and check out your generated path with the `path_sim.py`

`python offset_path_scan.py`  
This will generate `.npy` files for 7 more sensors, with results saved to disk in numpy array format. 
The example configuration will use ~15GB of disk space.

`python write_muxed_data.py`  
Finally to generate a data file in ACQ400 format.
By default this will only munge the first ~200k points into the binary format to keep the file size small.
The format is defined below:

| BYTE | 00 | 02 | 04 | 06 | 08 | 10 | .. | 60 | 62 | 64 | 68 | 72 | 76  | 80  | 84  | 88  | 92  |
|------|----|----|----|----|----|----|----|----|----|----|----|----|-----|-----|-----|-----|-----|
| AI   |CH01|CH02|CH03|CH04|CH05|CH06| .. |CH31|CH32|AQB1|AQB2|AQB3|SPAD0|SPAD1|SPAD2|SPAD3|SPAD4|
| FUNC |S1X |S1Y |S1Z |S1T |S2X |S2Y | .. |S8Z |S8T |XPOS|YPOS|ZPOS| CNT |USEC |USR1 |USR2 |USR3 |

## Output
An example of the final binary output should look something like:

```
~/PROJECTS/octo-bee$ hexdump -e '32/2 "%04x," 8/4 "%08x," "\n"' <  data/binary_data.bin | head

3cc4,21a4,14f4,3cc4,3d62,22fd,149b,3d62,3ea9,2490,13af,3ea9,407b,2671,12c9,407b,42c7,27a4,11e4,42c7,4581,2890,1106,4581,4897,29ad,1027,4897,4c03,2b0a,0f09,4c03,00000000,00000000,00000000,00000000,00000000,00002222,00003333,00005555,
3cc4,21a4,14f4,3cc4,3d63,22fd,149b,3d63,3ea9,2490,13af,3ea9,407b,2671,12c9,407b,42c8,27a4,11e4,42c8,4582,2890,1106,4582,4898,29ad,1027,4898,4c04,2b0a,0f09,4c04,00000000,00000011,00000000,00000001,00000064,00002222,00003333,00005555,
3cc5,21a4,14f4,3cc5,3d63,22fe,149b,3d63,3eaa,2490,13af,3eaa,407c,2671,12c9,407c,42c8,27a4,11e4,42c8,4583,2890,1107,4583,4899,29ad,1027,4899,4c05,2b0a,0f09,4c05,00000000,00000023,00000000,00000002,000000c8,00002222,00003333,00005555,
3cc5,21a4,14f4,3cc5,3d64,22fe,149b,3d64,3eaa,2490,13af,3eaa,407c,2672,12c9,407c,42c9,27a4,11e5,42c9,4583,2890,1107,4583,4899,29ad,1027,4899,4c05,2b0a,0f09,4c05,00000000,00000034,00000000,00000003,0000012c,00002222,00003333,00005555,
```

All data, intermediate and final, is stored in the `data/` directory e.g.
```
~/PROJECTS/octo-bee$ ls -l data
-rw-r--r-- 1 craig craig 2064720128 Jun 24 11:03 B-field_zoff_0.npy
-rw-r--r-- 1 craig craig 2064720128 Jun 24 11:04 B-field_zoff_10.npy
-rw-r--r-- 1 craig craig 2064720128 Jun 24 11:05 B-field_zoff_15.npy
-rw-r--r-- 1 craig craig 2064720128 Jun 24 11:05 B-field_zoff_20.npy
-rw-r--r-- 1 craig craig 2064720128 Jun 24 11:06 B-field_zoff_25.npy
-rw-r--r-- 1 craig craig 2064720128 Jun 24 11:06 B-field_zoff_30.npy
-rw-r--r-- 1 craig craig 2064720128 Jun 24 11:07 B-field_zoff_35.npy
-rw-r--r-- 1 craig craig 2064720128 Jun 24 11:04 B-field_zoff_5.npy
-rw-r--r-- 1 craig craig  678720000 Jun 24 11:09 binary_data.bin
-rw-r--r-- 1 craig craig 2064720128 Jun 24 11:02 recorded_scan_path.npy
```

The `B-field_zoff_` files are numpy arrays of the scan in order start to finish, where the final digits in the filename designate the sensor (by offset from origin in mm).

`binary_data.bin` is the final data product as would be generated from an ACQ400 system.

`recorded_scan_path.npy` is the generated ordered scan path from start to finish. This is the input to the magnetic simulation and is generated by the path simulation code.

# Path visualization

`python path_sim.py`  
To run the simulator of the 3D raster path scanner with a visualization of the object under test.
